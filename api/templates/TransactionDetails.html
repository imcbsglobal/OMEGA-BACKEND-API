{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

    body {
      font-family: "Inter", sans-serif;
      background-color: white;
    }

    .highlight-row {
      background-color: #fff8e1;
    }

    .highlight-text {
      color: #d32f2f;
    }

    .date-input {
      padding: 8px 12px;
      border-radius: 25px;
      border: 1px solid #ff6b6b;
      width: 100%;
      font-size: 16px;
      color: #666;
    }

    .search-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #ff6b6b;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      cursor: pointer;
    }

    .search-button:hover {
      background-color: #ff5252;
    }

    .table-container {
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid #ffe0e0;
    }

    .table-header {
      background-color: #ffefef;
      font-weight: 600;

    }

    .table-row {
      border-bottom: 1px solid #ffe0e0;
      font-size: small;
    }

    .table-cell {
      padding: 12px 15px;
      text-align: center;
    }

    .table-cell:first-child {
      text-align: center;
    }

    .dropdown-content {
      max-height: 200px;
      overflow-y: auto;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff6b6b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-message {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 16px;
      text-align: center;
    }

    .date-picker-input {
      width: 100%;
      border: none;
      background: transparent;
      outline: none;
      color: #666;
    }

    .date-container {
      position: relative;
    }

    .logo-container {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .stats-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .dashboard-card {
      background: linear-gradient(135deg, #EF4444 0%, #EF4444 100%);
      position: relative;
      overflow: hidden;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    /* Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .pagination-btn {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background-color: white;
      color: #4a5568;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 40px;
      text-align: center;
    }

    .pagination-btn:hover:not(:disabled) {
      background-color: #f7fafc;
      border-color: #cbd5e0;
    }

    .pagination-btn.active {
      background-color: #EF4444;
      color: white;
      border-color: #EF4444;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 14px;
      color: #718096;
      margin: 0 16px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="bg-red-500 text-white p-2 flex items-center justify-between">
    <a href="{% url 'home' %}" class="flex items-center">
      <i class="fas fa-house md:pl-20 pl-5 text-lg"></i>
    </a>
    <div class="logo-container">
      <img src="{% static 'images\omegawhite.png' %}" alt="">
    </div>
    <div class="flex items-center space-x-10 md:pr-18 pr-5">
      <a href="#" class="relative" id="filter-button">
        <i class="fas fa-filter text-xl"></i>
        <span id="filter-dot" class="hidden absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full"></span>
      </a>
      <button id="logout-btn" class="text-white hover:text-red-200">
        <i class="fas fa-sign-out-alt text-xl"></i>
      </button>
    </div>
  </header>

  <!-- Authentication Error Message -->
  <div id="auth-error" class="hidden error-message">
    <i class="fas fa-exclamation-triangle mr-2"></i>
    Your session has expired. Please
    <a href="/login/" class="underline font-medium">login again</a>.
  </div>

  <!-- Company Dashboard Card -->
  <div class="dashboard-card rounded-2xl p-6 mb-6 text-white mt-5 md:mx-20 mx-3">
    <div class="flex items-center justify-center mb-4">
      <h2 class="text-2xl font-bold text-center">Transaction Analytics</h2>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 stats-grid">
      <div class="stats-card rounded-xl p-4 text-center">
        <div class="text-lg font-bold text-gray-800" id="total-transactions">...</div>
        <div class="text-xs text-gray-600">Total Products</div>
      </div>
      <div class="stats-card rounded-xl p-4 text-center">
        <div class="text-lg font-bold text-green-600" id="total-sales">...</div>
        <div class="text-xs text-gray-600">Total Sales</div>
      </div>
      <div class="stats-card rounded-xl p-4 text-center">
        <div class="text-lg font-bold text-blue-600" id="total-production">...</div>
        <div class="text-xs text-gray-600">Total Purchase Qty</div>
      </div>
      <div class="stats-card rounded-xl p-4 text-center">
        <div class="text-lg font-bold text-purple-600" id="total-product-qty">...</div>
        <div class="text-xs text-gray-600">Total Product Qty</div>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div id="filter-panel"
    class="hidden fixed top-16 right-5 shadow-xl bg-white rounded-lg z-10 w-64 border border-gray-200">
    <div class="p-3 border-b border-gray-200 font-medium text-gray-700">
      Filter By
    </div>
    <ul>
      <li class="px-4 py-3 cursor-pointer hover:bg-gray-50" id="all-products-filter">
        <span>All Products</span>
      </li>
      <li class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative" id="stock-category-filter">
        <div class="flex items-center justify-between">
          <span>Stock Category</span>
          <i class="fas fa-chevron-down text-xs text-gray-400" id="category-arrow"></i>
        </div>
        <div class="hidden mt-2 dropdown-content" id="category-dropdown">
          <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
            <div class="p-2 text-center text-gray-500">
              <div class="loading"></div>
            </div>
          </div>
        </div>
      </li>
      <li class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative" id="product-filter">
        <div class="flex items-center justify-between">
          <span>Product</span>
          <i class="fas fa-chevron-down text-xs text-gray-400" id="product-arrow"></i>
        </div>
        <div class="hidden mt-2 dropdown-content" id="product-dropdown">
          <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
            <div class="p-2 text-center text-gray-500">
              <div class="loading"></div>
            </div>
          </div>
        </div>
      </li>
      <li class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative" id="brand-filter">
        <div class="flex items-center justify-between">
          <span>Brand</span>
          <i class="fas fa-chevron-down text-xs text-gray-400" id="brand-arrow"></i>
        </div>
        <div class="hidden mt-2 dropdown-content" id="brand-dropdown">
          <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
            <div class="p-2 text-center text-gray-500">
              <div class="loading"></div>
            </div>
          </div>
        </div>
      </li>
    </ul>
    <div class="p-3 border-t border-gray-200 flex justify-end">
      <button class="text-red-500 font-medium text-sm" id="apply-filters-btn">
        Apply Filters
      </button>
    </div>
  </div>

  <!-- Date Range Selector -->
  <div class="p-3 bg-white md:mx-20 mx-2">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between md:space-x-3 space-y-3 md:space-y-0">

      <!-- From Date -->
      <div class="relative flex-1">
        <div class="border border-red-300 rounded-full px-4 py-2 flex items-center">
          <input type="text" id="from-date" placeholder="From Date"
            class="date-picker-input w-full bg-transparent focus:outline-none" readonly />
          <i class="fas fa-calendar ml-auto text-gray-400"></i>
        </div>
      </div>

      <!-- To Date -->
      <div class="relative flex-1">
        <div class="border border-red-300 rounded-full px-4 py-2 flex items-center">
          <input type="text" id="to-date" placeholder="To Date"
            class="date-picker-input w-full bg-transparent focus:outline-none" readonly />
          <i class="fas fa-calendar ml-auto text-gray-400"></i>
        </div>
      </div>

      <!-- Search Icon Button -->
      <div class="flex justify-center md:justify-start">
        <div class="bg-red-500 hover:bg-red-600 transition-colors p-3 rounded-full cursor-pointer " id="search-button">
          <i class="fas fa-search text-white text-lg"></i>
        </div>
      </div>

      <!-- Search Input -->
      <div class="relative flex-1">
        <input type="text" placeholder="Search products.."
          class="search-input w-full py-3 pl-4 pr-10 border border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white/80"
          id="search-input" />
        <button class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 transition-colors"
          id="text-search-button">
          <i class="fas fa-search text-lg"></i>
        </button>
      </div>


    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="px-4 py-8 text-center hidden" id="loading-indicator">
    <div class="loading mx-auto"></div>
    <p class="mt-2 text-gray-500">Loading transaction data...</p>
  </div>

  <!-- Transaction Table -->
  <div class="px-3 pb-6 md:mx-20 mx-2" id="table-container">
    <div class="table-container">
      <div class="table-header grid grid-cols-4">
        <div class="table-cell px-1 text-sm">Product Name</div>
        <div class="table-cell px-1 text-sm">Sales Qty</div>
        <div class="table-cell px-1 text-sm">Purchase Qty</div>
        <div class="table-cell px-1 text-sm">Production Qty</div>
      </div>

      <div id="transactions-table-body">
        <!-- Transaction data will be loaded here -->
      </div>
    </div>
    <!-- Pagination Controls -->
    <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6 m-10">
      <div class="flex flex-col space-y-4 sm:space-y-0 sm:flex-row sm:items-center sm:justify-between">

        <!-- Page size selector -->
        <div class="flex items-center space-x-2">
          <span class="text-sm">Show:</span>
          <select id="page-size-select" class="border rounded px-2 py-1 text-sm">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span class="text-sm">per page</span>
        </div>

        <!-- Pagination info -->
        <div class="text-sm text-center sm:text-left" id="pagination-info">
          <!-- Pagination info will be inserted here -->
        </div>

        <!-- Pagination buttons -->
        <div class="flex justify-center sm:justify-end" id="pagination-container">
          <!-- Pagination buttons will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- No Results Message -->
  <div class="px-4 py-8 text-center hidden" id="no-results">
    <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
    <p class="text-gray-500">
      No transaction data found for the selected criteria.
    </p>
    <p class="text-gray-400 text-sm mt-2">
      Try adjusting your date range or filters.
    </p>
  </div>

  <!-- Date Range Info -->
  <div class="px-4 py-2 text-center text-gray-500 text-sm hidden" id="date-range-info">
    <i class="fas fa-info-circle mr-1"></i>
    <span id="date-range-text">Please select a date range to view transactions</span>
  </div>

  <!-- JavaScript for Date Pickers and API Integration -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Global variables
    let stockCategories = [];
    let products = [];
    let brands = [];
    let currentFilters = {
      stockCategory: null,
      product: null,
      brand: null,
    };
    let fromDatePicker, toDatePicker;
    let allTransactionData = [];
    let currentPage = 1;
    let pageSize = 10;
    let isDateFiltered = false;
    let originalTransactionData = [];
    // API Base URL
    const API_BASE_URL = "http://127.0.0.1:8000/api";

    // Authentication utilities
    function getAuthToken() {
      const token = localStorage.getItem("token");
      if (!token) {
        showAuthError();
        return null;
      }
      return token;
    }

    function getAuthHeaders() {
      const token = getAuthToken();
      if (!token) return null;

      return {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      };
    }

    function showAuthError() {
      document.getElementById("auth-error").classList.remove("hidden");
      document.getElementById("table-container").classList.add("hidden");
      document.getElementById("loading-indicator").classList.add("hidden");
      document.getElementById("date-range-info").classList.add("hidden");
    }

    function hideAuthError() {
      document.getElementById("auth-error").classList.add("hidden");
    }

    function handleAuthError() {
      localStorage.removeItem("token");
      showAuthError();
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "/login/";
    }

    // Enhanced fetch function with authentication
    async function authenticatedFetch(url, options = {}) {
      const headers = getAuthHeaders();
      if (!headers) {
        throw new Error("No authentication token");
      }

      const response = await fetch(url, {
        ...options,
        headers: {
          ...headers,
          ...options.headers,
        },
      });

      if (response.status === 401 || response.status === 403) {
        handleAuthError();
        throw new Error("Authentication failed");
      }

      return response;
    }

    // Initialize the page
    document.addEventListener("DOMContentLoaded", function () {
      // Check if user is authenticated
      if (!getAuthToken()) {
        showAuthError();
        return;
      }

      hideAuthError();
      initializeDashboard();
      initializeDatePickers();
      loadInitialData();
      setupEventListeners();
      showInitialMessage();
    });

    function initializeDatePickers() {
      // Initialize From Date picker
      fromDatePicker = flatpickr("#from-date", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        onChange: function (selectedDates, dateStr, instance) {
          // Update To Date picker minDate
          if (toDatePicker && dateStr) {
            toDatePicker.set("minDate", dateStr);
          }
          updateDateRangeInfo();
        },
      });

      // Initialize To Date picker
      toDatePicker = flatpickr("#to-date", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        onChange: function (selectedDates, dateStr, instance) {
          // Update From Date picker maxDate
          if (fromDatePicker && dateStr) {
            fromDatePicker.set("maxDate", dateStr);
          }
          updateDateRangeInfo();
        },
      });
    }

    function setupEventListeners() {
      // Logout button
      document.getElementById("logout-btn").addEventListener("click", logout);

      // Filter panel toggle
      document
        .getElementById("filter-button")
        .addEventListener("click", toggleFilterPanel);

      // Filter dropdown toggles
      document
        .getElementById("stock-category-filter")
        .addEventListener("click", (e) => {
          if (e.target.closest(".dropdown-content")) return;
          toggleDropdown("category");
        });

      document
        .getElementById("product-filter")
        .addEventListener("click", (e) => {
          if (e.target.closest(".dropdown-content")) return;
          toggleDropdown("product");
        });

      document
        .getElementById("brand-filter")
        .addEventListener("click", (e) => {
          if (e.target.closest(".dropdown-content")) return;
          toggleDropdown("brand");
        });

      // All products filter
      document
        .getElementById("all-products-filter")
        .addEventListener("click", () => {
          clearAllFilters();
          if (hasValidDateRange()) {
            loadTransactionsByDate();
          } else {
            loadTransactionSummary();
          }
          toggleFilterPanel();
        });

      // Apply filters button
      document
        .getElementById("apply-filters-btn")
        .addEventListener("click", () => {
          if (hasValidDateRange()) {
            loadTransactionsByDate();
          } else {
            loadTransactionSummary();
          }
          toggleFilterPanel();
        });

      // Search functionality
      // Text search input
      document.getElementById("search-input").addEventListener("input", handleSearch);
      document.getElementById("text-search-button").addEventListener("click", handleSearch);

      // Page size selector
      document.getElementById("page-size-select").addEventListener("change", function (e) {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        updatePaginatedTransactions();
      });
    }
    document
      .getElementById("search-button")
      .addEventListener("click", () => {
        if (hasValidDateRange()) {
          loadTransactionsByDate();
        } else {
          showError("Please select both from and to dates.");
        }
      });

    function hasValidDateRange() {
      const fromDate = document.getElementById("from-date").value;
      const toDate = document.getElementById("to-date").value;
      return fromDate && toDate;
    }

    function updateDateRangeInfo() {
      const fromDate = document.getElementById("from-date").value;
      const toDate = document.getElementById("to-date").value;
      const dateRangeInfo = document.getElementById("date-range-info");
      const dateRangeText = document.getElementById("date-range-text");

      if (fromDate && toDate) {
        dateRangeText.textContent = `Showing data from ${fromDate} to ${toDate}`;
        dateRangeInfo.classList.remove("hidden");
      } else if (fromDate || toDate) {
        dateRangeText.textContent = "Please select both start and end dates";
        dateRangeInfo.classList.remove("hidden");
      } else {
        dateRangeInfo.classList.add("hidden");
      }
    }

    function showInitialMessage() {
      document.getElementById("date-range-info").classList.remove("hidden");
      document.getElementById("date-range-text").textContent =
        "Select a date range above to view transactions, or load all product summaries";
    }

    async function loadInitialData() {
      try {
        // Load filter options
        await Promise.all([
          loadStockCategories(),
          loadProductsList(),
          loadBrands(),
        ]);

        // Load initial transaction summary (without date filter)
        await loadTransactionSummary();
      } catch (error) {
        console.error("Error loading initial data:", error);
        if (
          error.message === "Authentication failed" ||
          error.message === "No authentication token"
        ) {
          return;
        }
        showError("Failed to load initial data. Please try again.");
      }
    }
    async function loadTransactionSummary() {
      showLoading();
      isDateFiltered = false;

      // Clear search input when loading new data
      document.getElementById("search-input").value = '';

      try {
        let url = `${API_BASE_URL}/product-summary/`;
        const params = new URLSearchParams();

        if (currentFilters.stockCategory) {
          params.append("stockCategory", currentFilters.stockCategory);
        }
        if (currentFilters.product) {
          params.append("product", currentFilters.product);
        }
        if (currentFilters.brand) {
          params.append("brand", currentFilters.brand);
        }

        if (params.toString()) {
          url += "?" + params.toString();
        }

        const response = await authenticatedFetch(url);
        const data = await response.json();

        if (data.success) {
          originalTransactionData = data.data; // Store original data
          allTransactionData = [...originalTransactionData]; // Set working data
          updatePaginatedTransactions();
          updatePaginationControls();
        } else {
          throw new Error(data.error || "Failed to load transaction summary");
        }
      } catch (error) {
        console.error("Error loading transaction summary:", error);
        if (
          error.message === "Authentication failed" ||
          error.message === "No authentication token"
        ) {
          return;
        }
        showError("Failed to load transaction data. Please try again.");
      } finally {
        hideLoading();
      }
    }

    async function loadTransactionsByDate() {
      const fromDate = document.getElementById("from-date").value;
      const toDate = document.getElementById("to-date").value;

      if (!fromDate || !toDate) {
        showError("Please select both from and to dates.");
        return;
      }

      showLoading();
      isDateFiltered = true;

      // Clear search input when loading new data
      document.getElementById("search-input").value = '';

      try {
        let url = `${API_BASE_URL}/product-summary-by-date/`;
        const params = new URLSearchParams();

        params.append("fromDate", fromDate);
        params.append("toDate", toDate);

        if (currentFilters.stockCategory) {
          params.append("stockCategory", currentFilters.stockCategory);
        }
        if (currentFilters.product) {
          params.append("product", currentFilters.product);
        }
        if (currentFilters.brand) {
          params.append("brand", currentFilters.brand);
        }

        url += "?" + params.toString();

        const response = await authenticatedFetch(url);
        const data = await response.json();

        if (data.success) {
          originalTransactionData = data.data; // Store original data
          allTransactionData = [...originalTransactionData]; // Set working data
          updatePaginatedTransactions();
          updatePaginationControls();
        } else {
          throw new Error(
            data.error || "Failed to load transaction data by date"
          );
        }
      } catch (error) {
        console.error("Error loading transactions by date:", error);
        if (
          error.message === "Authentication failed" ||
          error.message === "No authentication token"
        ) {
          return;
        }
        showError("Failed to load transaction data. Please try again.");
      } finally {
        hideLoading();
      }
    }

    function handleSearch() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase().trim();
      
      if (searchTerm === '') {
        // If search is empty, restore original data
        allTransactionData = [...originalTransactionData];
      } else {
        // Filter the original data
        allTransactionData = originalTransactionData.filter(transaction => {
          const productName = transaction.name ? transaction.name.toLowerCase() : '';
          return productName.includes(searchTerm);
        });
      }
      
      currentPage = 1; // Reset to first page
      updatePaginatedTransactions();
      updatePaginationControls();
    }

    function updatePaginatedTransactions() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const paginated = allTransactionData.slice(start, end);

      // Update dashboard with ALL filtered data (not just paginated)
      updateDashboardStats(allTransactionData, isDateFiltered);

      // Display only paginated data in table
      displayPaginatedTable(paginated, isDateFiltered);
    }

    function updatePaginationControls() {
      const container = document.getElementById("pagination-container");
      const info = document.getElementById("pagination-info");

      const total = allTransactionData.length;
      const totalPages = Math.ceil(total / pageSize);

      const start = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);
      info.textContent = `Showing ${start}-${end} of ${total} results`;

      container.innerHTML = "";

      if (totalPages <= 1) return;

      const createBtn = (text, page, active = false, disabled = false) => {
        const btn = document.createElement("button");
        btn.className = `pagination-btn ${active ? "active" : ""}`;
        btn.textContent = text;
        btn.disabled = disabled;
        if (!disabled) {
          btn.addEventListener("click", () => {
            currentPage = page;
            updatePaginatedTransactions();
            updatePaginationControls();
          });
        }
        return btn;
      };

      // Previous
      container.appendChild(createBtn("←", currentPage - 1, false, currentPage === 1));

      // Pages
      const maxPages = 3;
      let startPage = Math.max(1, currentPage - 1);
      let endPage = Math.min(startPage + maxPages - 1, totalPages);
      for (let i = startPage; i <= endPage; i++) {
        container.appendChild(createBtn(i, i, i === currentPage));
      }

      // Next
      container.appendChild(createBtn("→", currentPage + 1, false, currentPage === totalPages));
    }

    // Dashboard functions
    function initializeDashboard() {
      document.getElementById("total-transactions").textContent = "...";
      document.getElementById("total-sales").textContent = "...";
      document.getElementById("total-production").textContent = "...";
      document.getElementById("total-product-qty").textContent = "...";
    }

    function updateDashboardStats(transactionsData, isDateFiltered) {
      if (!transactionsData || transactionsData.length === 0) {
        // Reset to zero if no data
        document.getElementById("total-transactions").textContent = "0";
        document.getElementById("total-sales").textContent = "0";
        document.getElementById("total-production").textContent = "0";
        document.getElementById("total-product-qty").textContent = "0";
        return;
      }

      // Calculate totals
      let totalProducts = transactionsData.length;
      let totalSales = 0;
      let totalPurchase = 0;
      let totalProductQty = 0;

      transactionsData.forEach(transaction => {
        // Handle different field names based on data source
        const salesQty = isDateFiltered
          ? (transaction.sales_quantity || 0)
          : (transaction.inv_quantity || 0);

        const purchaseQty = isDateFiltered
          ? (transaction.purchase_quantity || 0)
          : (transaction.purchase_quantity || 0);

        const productionQty = isDateFiltered
          ? (transaction.production_quantity || 0)
          : (transaction.production_quantity || 0);

        totalSales += Number(salesQty);
        totalPurchase += Number(purchaseQty);
        totalProductQty += Number(productionQty);
      });

      // Update dashboard elements with animated counting effect
      animateNumber("total-transactions", totalProducts);
      animateNumber("total-sales", Math.round(totalSales));
      animateNumber("total-production", Math.round(totalPurchase));
      animateNumber("total-product-qty", Math.round(totalProductQty));
    }

    // Animated number counting function
    function animateNumber(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const startValue = parseInt(element.textContent) || 0;
      const duration = 1000; // 1 second
      const startTime = Date.now();

      function updateNumber() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Easing function for smooth animation
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.round(startValue + (targetValue - startValue) * easeOut);

        element.textContent = currentValue.toLocaleString();

        if (progress < 1) {
          requestAnimationFrame(updateNumber);
        }
      }

      requestAnimationFrame(updateNumber);
    }

    // Table display functions
    function displayPaginatedTable(transactionsData, isDateFiltered) {
      const tableBody = document.getElementById("transactions-table-body");
      const noResults = document.getElementById("no-results");
      const tableContainer = document.getElementById("table-container");

      if (!transactionsData || transactionsData.length === 0) {
        tableContainer.classList.add("hidden");
        noResults.classList.remove("hidden");
        return;
      }

      tableContainer.classList.remove("hidden");
      noResults.classList.add("hidden");

      tableBody.innerHTML = "";

      transactionsData.forEach((transaction, index) => {
        const row = document.createElement("div");
        row.className = `table-row grid grid-cols-4 ${index % 2 === 0 ? "" : "bg-gray-50"
          }`;

        const salesQty = isDateFiltered
          ? transaction.sales_quantity || 0
          : transaction.inv_quantity || 0;
        const purchaseQty = isDateFiltered
          ? transaction.purchase_quantity || 0
          : transaction.purchase_quantity || 0;
        const productionQty = isDateFiltered
          ? transaction.production_quantity || 0
          : transaction.production_quantity || 0;

        const isHighActivity =
          salesQty > 50 || purchaseQty > 50 || productionQty > 1000;
        if (isHighActivity) {
          row.className += " highlight-row";
        }

        row.innerHTML = `
            <div class="table-cell ${isHighActivity ? "highlight-text" : ""}">${transaction.name || "N/A"
          }</div>
            <div class="table-cell ${isHighActivity ? "highlight-text" : ""
          }">${Math.round(salesQty).toLocaleString()}</div>
            <div class="table-cell ${isHighActivity ? "highlight-text" : ""
          }">${Math.round(purchaseQty).toLocaleString()}</div>
            <div class="table-cell ${isHighActivity ? "highlight-text" : ""
          }">${Math.round(productionQty).toLocaleString()}</div>
          `;

        tableBody.appendChild(row);
      });
    }

    async function loadStockCategories() {
      try {
        const response = await authenticatedFetch(
          `${API_BASE_URL}/stock-categories/`
        );
        const data = await response.json();

        if (data.success) {
          stockCategories = data.data;
          populateDropdown("category", stockCategories);
        }
      } catch (error) {
        console.error("Error loading stock categories:", error);
      }
    }

    async function loadProductsList() {
      try {
        const response = await authenticatedFetch(
          `${API_BASE_URL}/products-list/`
        );
        const data = await response.json();

        if (data.success) {
          products = data.data;
          populateDropdown("product", products);
        }
      } catch (error) {
        console.error("Error loading products list:", error);
      }
    }

    async function loadBrands() {
      try {
        const response = await authenticatedFetch(`${API_BASE_URL}/brands/`);
        const data = await response.json();

        if (data.success) {
          brands = data.data;
          populateDropdown("brand", brands);
        }
      } catch (error) {
        console.error("Error loading brands:", error);
      }
    }

    function populateDropdown(type, items) {
      const dropdownId = `${type}-dropdown`;
      const dropdown = document.getElementById(dropdownId);

      if (!dropdown) return;

      dropdown.innerHTML = "";

      items.forEach((item) => {
        const div = document.createElement("div");
        div.className = "px-3 py-2 cursor-pointer hover:bg-gray-200 text-sm";
        div.textContent = item;
        div.addEventListener("click", () => selectFilter(type, item));
        dropdown.appendChild(div);
      });
    }

    function selectFilter(type, value) {
      if (type === "category") {
        currentFilters.stockCategory = value;
      } else if (type === "product") {
        currentFilters.product = value;
      } else if (type === "brand") {
        currentFilters.brand = value;
      }

      updateFilterIndicator();

      // Close the dropdown
      document.getElementById(`${type}-dropdown`).classList.add("hidden");
      document
        .getElementById(`${type}-arrow`)
        .classList.remove("fa-chevron-up");
      document
        .getElementById(`${type}-arrow`)
        .classList.add("fa-chevron-down");
    }

    function clearAllFilters() {
      currentFilters = {
        stockCategory: null,
        product: null,
        brand: null,
      };
      updateFilterIndicator();
    }

    function updateFilterIndicator() {
      const filterDot = document.getElementById("filter-dot");
      const hasFilters =
        currentFilters.stockCategory ||
        currentFilters.product ||
        currentFilters.brand;

      if (hasFilters) {
        filterDot.classList.remove("hidden");
      } else {
        filterDot.classList.add("hidden");
      }
    }

    function toggleFilterPanel() {
      const filterPanel = document.getElementById("filter-panel");
      filterPanel.classList.toggle("hidden");
    }

    function toggleDropdown(type) {
      const dropdown = document.getElementById(`${type}-dropdown`);
      const arrow = document.getElementById(`${type}-arrow`);

      dropdown.classList.toggle("hidden");

      if (dropdown.classList.contains("hidden")) {
        arrow.classList.remove("fa-chevron-up");
        arrow.classList.add("fa-chevron-down");
      } else {
        arrow.classList.remove("fa-chevron-down");
        arrow.classList.add("fa-chevron-up");
      }
    }

    function showLoading() {
      document.getElementById("loading-indicator").classList.remove("hidden");
      document.getElementById("table-container").classList.add("hidden");
      document.getElementById("no-results").classList.add("hidden");
    }

    function hideLoading() {
      document.getElementById("loading-indicator").classList.add("hidden");
    }

    function showError(message) {
      alert(message); // You can replace this with a more elegant error display
    }

    // Close filter panel when clicking outside
    document.addEventListener("click", function (event) {
      const filterPanel = document.getElementById("filter-panel");
      const filterButton = document.getElementById("filter-button");

      if (
        !filterPanel.contains(event.target) &&
        !filterButton.contains(event.target)
      ) {
        filterPanel.classList.add("hidden");
      }
    });
  </script>
</body>

</html>